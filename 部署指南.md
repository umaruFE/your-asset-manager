# 资产管理系统 - 阿里云服务器部署指南

本指南将帮助您将资产管理系统部署到阿里云服务器上。

## 目录

1. [服务器环境准备](#1-服务器环境准备)
2. [代码部署](#2-代码部署)
3. [数据库配置](#3-数据库配置)
4. [后端服务配置](#4-后端服务配置)
5. [前端构建和部署](#5-前端构建和部署)
6. [Nginx 配置](#6-nginx-配置)
7. [进程管理（PM2）](#7-进程管理pm2)
8. [域名和 SSL 证书（可选）](#8-域名和-ssl-证书可选)
9. [常见问题](#9-常见问题)

---

## 1. 服务器环境准备

### 1.1 购买阿里云服务器

推荐配置：
- **CPU**: 2核或以上
- **内存**: 4GB或以上
- **系统**: Ubuntu 20.04/22.04 LTS 或 CentOS 7/8
- **带宽**: 3Mbps或以上

### 1.2 连接到服务器

使用 SSH 连接到服务器：

```bash
ssh root@your-server-ip
```

### 1.3 安装 Node.js

**Ubuntu/Debian:**

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Node.js 18.x LTS
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version  # 应该显示 v18.x.x
npm --version
```

**CentOS/RHEL:**

```bash
# 更新系统
sudo yum update -y

# 安装 Node.js 18.x LTS
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# 验证安装
node --version
npm --version
```

### 1.4 安装 PostgreSQL

**Ubuntu/Debian:**

```bash
# 安装 PostgreSQL
sudo apt install -y postgresql postgresql-contrib

# 启动 PostgreSQL 服务
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 设置 postgres 用户密码
sudo -u postgres psql -c "ALTER USER postgres PASSWORD 'your_secure_password';"
```

**CentOS/RHEL:**

```bash
# 安装 PostgreSQL
sudo yum install -y postgresql-server postgresql-contrib

# 初始化数据库
sudo postgresql-setup initdb

# 启动 PostgreSQL 服务
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 设置 postgres 用户密码
sudo -u postgres psql -c "ALTER USER postgres PASSWORD 'your_secure_password';"
```

### 1.5 安装 Nginx

**Ubuntu/Debian:**

```bash
sudo apt install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

**CentOS/RHEL:**

```bash
sudo yum install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 1.6 安装 PM2（进程管理器）

```bash
sudo npm install -g pm2
```

---

## 2. 代码部署

### 2.1 上传代码到服务器

**方法一：使用 Git（推荐）**

```bash
# 在服务器上安装 Git
sudo apt install -y git  # Ubuntu/Debian
# 或
sudo yum install -y git  # CentOS/RHEL

# 克隆项目（如果使用 Git 仓库）
cd /var/www
sudo git clone https://your-repository-url.git asset-manager
sudo chown -R $USER:$USER asset-manager
cd asset-manager
```

**方法二：使用 SCP 上传**

在本地电脑执行：

```bash
# 打包项目（排除 node_modules）
tar --exclude='node_modules' --exclude='.git' -czf asset-manager.tar.gz .

# 上传到服务器
scp asset-manager.tar.gz root@your-server-ip:/var/www/

# 在服务器上解压
ssh root@your-server-ip
cd /var/www
mkdir -p asset-manager
tar -xzf asset-manager.tar.gz -C asset-manager
cd asset-manager
```

**方法三：使用 FTP/SFTP 工具**

使用 FileZilla、WinSCP 等工具上传项目文件。

### 2.2 安装依赖

```bash
# 安装后端依赖
cd server
npm install --production

# 安装前端依赖
cd ..
npm install
```

---

## 3. 数据库配置

### 3.1 创建数据库和用户

```bash
# 切换到 postgres 用户
sudo -u postgres psql

# 在 PostgreSQL 中执行以下命令
CREATE DATABASE asset_manager;
CREATE USER asset_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE asset_manager TO asset_user;
\q
```

### 3.2 配置 PostgreSQL 远程访问（如果需要）

编辑 PostgreSQL 配置文件：

```bash
# Ubuntu/Debian
sudo nano /etc/postgresql/14/main/postgresql.conf
# CentOS/RHEL
sudo nano /var/lib/pgsql/data/postgresql.conf
```

找到并修改：

```conf
listen_addresses = '*'  # 或 'localhost'（如果只本地访问）
```

编辑 `pg_hba.conf`：

```bash
# Ubuntu/Debian
sudo nano /etc/postgresql/14/main/pg_hba.conf
# CentOS/RHEL
sudo nano /var/lib/pgsql/data/pg_hba.conf
```

添加：

```
host    asset_manager    asset_user    0.0.0.0/0    md5
```

重启 PostgreSQL：

```bash
sudo systemctl restart postgresql
```

### 3.3 导入数据库结构

```bash
cd /var/www/asset-manager
sudo -u postgres psql -d asset_manager -f database/schema.sql
```

### 3.4 初始化用户数据

```bash
cd /var/www/asset-manager/server
npm run init-db
```

---

## 4. 后端服务配置

### 4.1 创建环境变量文件

```bash
cd /var/www/asset-manager/server
nano .env
```

添加以下内容：

```env
# 数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_USER=asset_user
DB_PASSWORD=your_secure_password
DB_NAME=asset_manager

# JWT 配置
JWT_SECRET=your_super_secret_jwt_key_change_this_to_a_random_string_in_production
JWT_EXPIRES_IN=7d

# 服务器配置
PORT=3001
NODE_ENV=production

# CORS 配置（前端域名，例如：https://yourdomain.com）
CORS_ORIGIN=https://yourdomain.com
```

**重要提示：**
- `JWT_SECRET` 必须是一个强随机字符串，可以使用以下命令生成：
  ```bash
  node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
  ```
- `CORS_ORIGIN` 应该设置为您的前端域名（带协议，如 `https://yourdomain.com`）

### 4.2 测试后端服务

```bash
cd /var/www/asset-manager/server
npm start
```

如果看到 "Server is running on port 3001"，说明配置正确。按 `Ctrl+C` 停止。

### 4.3 使用 PM2 启动后端服务

```bash
cd /var/www/asset-manager/server

# 启动服务
pm2 start index.js --name asset-manager-api

# 设置开机自启
pm2 startup
pm2 save

# 查看服务状态
pm2 status

# 查看日志
pm2 logs asset-manager-api
```

---

## 5. 前端构建和部署

### 5.1 配置前端环境变量

在项目根目录创建 `.env.production` 文件：

```bash
cd /var/www/asset-manager
nano .env.production
```

添加：

```env
VITE_API_BASE_URL=https://yourdomain.com/api
```

**注意：** 如果后端和前端在同一域名下，可以设置为相对路径：
```env
VITE_API_BASE_URL=/api
```

### 5.2 构建前端

```bash
cd /var/www/asset-manager
npm run build
```

构建完成后，会在 `dist` 目录生成静态文件。

### 5.3 检查构建结果

```bash
ls -la dist/
```

应该看到 `index.html` 和其他静态文件。

---

## 6. Nginx 配置

### 6.1 创建 Nginx 配置文件

```bash
sudo nano /etc/nginx/sites-available/asset-manager
```

**Ubuntu/Debian** 使用 `sites-available`，**CentOS/RHEL** 使用 `/etc/nginx/conf.d/asset-manager.conf`

添加以下配置：

```nginx
# 前端静态文件服务
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;  # 替换为您的域名或IP

    # 前端静态文件目录
    root /var/www/asset-manager/dist;
    index index.html;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;

    # 前端路由（SPA）
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API 代理到后端
    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### 6.2 启用站点

**Ubuntu/Debian:**

```bash
sudo ln -s /etc/nginx/sites-available/asset-manager /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置
sudo systemctl reload nginx
```

**CentOS/RHEL:**

```bash
sudo nginx -t  # 测试配置
sudo systemctl reload nginx
```

### 6.3 配置防火墙

```bash
# Ubuntu/Debian (UFW)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

---

## 7. 进程管理（PM2）

### 7.1 PM2 常用命令

```bash
# 查看所有进程
pm2 list

# 查看日志
pm2 logs asset-manager-api

# 重启服务
pm2 restart asset-manager-api

# 停止服务
pm2 stop asset-manager-api

# 删除服务
pm2 delete asset-manager-api

# 查看详细信息
pm2 info asset-manager-api

# 监控
pm2 monit
```

### 7.2 PM2 配置文件（可选）

创建 `server/ecosystem.config.js`：

```javascript
export default {
  apps: [{
    name: 'asset-manager-api',
    script: 'index.js',
    instances: 1,
    exec_mode: 'fork',
    env: {
      NODE_ENV: 'production',
      PORT: 3001
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G'
  }]
};
```

使用配置文件启动：

```bash
pm2 start ecosystem.config.js
```

---

## 8. 域名和 SSL 证书（可选）

### 8.1 配置域名解析

在域名服务商处添加 A 记录：
- 主机记录：`@` 或 `www`
- 记录值：服务器 IP 地址

### 8.2 安装 SSL 证书（Let's Encrypt）

```bash
# 安装 Certbot
sudo apt install -y certbot python3-certbot-nginx  # Ubuntu/Debian
# 或
sudo yum install -y certbot python3-certbot-nginx  # CentOS/RHEL

# 获取证书
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# 自动续期测试
sudo certbot renew --dry-run
```

Certbot 会自动修改 Nginx 配置，添加 HTTPS 支持。

### 8.3 更新前端 API 地址

如果使用了 HTTPS，需要更新前端环境变量：

```bash
nano /var/www/asset-manager/.env.production
```

修改为：

```env
VITE_API_BASE_URL=https://yourdomain.com/api
```

重新构建前端：

```bash
cd /var/www/asset-manager
npm run build
```

---

## 9. 常见问题

### 9.1 数据库连接失败

**问题：** 后端无法连接到数据库

**解决方案：**
1. 检查 PostgreSQL 服务是否运行：
   ```bash
   sudo systemctl status postgresql
   ```
2. 检查 `.env` 文件中的数据库配置
3. 测试数据库连接：
   ```bash
   psql -h localhost -U asset_user -d asset_manager
   ```
4. 检查 PostgreSQL 日志：
   ```bash
   sudo tail -f /var/log/postgresql/postgresql-14-main.log
   ```

### 9.2 前端无法访问后端 API

**问题：** 前端显示网络错误或 CORS 错误

**解决方案：**
1. 检查后端服务是否运行：
   ```bash
   pm2 status
   curl http://localhost:3001/api/health
   ```
2. 检查 Nginx 配置中的 `proxy_pass` 是否正确
3. 检查 `CORS_ORIGIN` 环境变量是否匹配前端域名
4. 查看 Nginx 错误日志：
   ```bash
   sudo tail -f /var/log/nginx/error.log
   ```

### 9.3 静态文件 404 错误

**问题：** 前端页面可以访问，但静态资源（CSS、JS）404

**解决方案：**
1. 检查 `dist` 目录是否存在且包含文件：
   ```bash
   ls -la /var/www/asset-manager/dist
   ```
2. 检查 Nginx 配置中的 `root` 路径是否正确
3. 检查文件权限：
   ```bash
   sudo chown -R www-data:www-data /var/www/asset-manager/dist
   ```

### 9.4 PM2 服务无法启动

**问题：** PM2 启动失败

**解决方案：**
1. 查看详细错误信息：
   ```bash
   pm2 logs asset-manager-api --lines 50
   ```
2. 检查 Node.js 版本：
   ```bash
   node --version
   ```
3. 检查依赖是否安装：
   ```bash
   cd /var/www/asset-manager/server
   npm install --production
   ```
4. 手动运行测试：
   ```bash
   cd /var/www/asset-manager/server
   node index.js
   ```

### 9.5 端口被占用

**问题：** 端口 3001 已被占用

**解决方案：**
1. 查找占用端口的进程：
   ```bash
   sudo lsof -i :3001
   # 或
   sudo netstat -tulpn | grep 3001
   ```
2. 修改 `.env` 文件中的 `PORT` 配置
3. 更新 Nginx 配置中的 `proxy_pass` 端口

### 9.6 内存不足

**问题：** 服务器内存不足

**解决方案：**
1. 检查内存使用：
   ```bash
   free -h
   ```
2. 优化 PM2 配置，限制内存使用
3. 考虑升级服务器配置

---

## 10. 部署检查清单

部署完成后，请检查以下项目：

- [ ] PostgreSQL 服务运行正常
- [ ] 数据库已创建并导入结构
- [ ] 用户数据已初始化
- [ ] 后端 `.env` 文件配置正确
- [ ] 后端服务通过 PM2 运行
- [ ] 前端已构建（`dist` 目录存在）
- [ ] 前端 `.env.production` 配置正确
- [ ] Nginx 配置正确且已重载
- [ ] 防火墙规则已配置
- [ ] 可以通过域名或 IP 访问前端
- [ ] API 请求正常（检查浏览器控制台）
- [ ] SSL 证书已安装（如果使用 HTTPS）
- [ ] PM2 开机自启已配置

---

## 11. 更新部署

当需要更新代码时：

```bash
# 1. 备份当前版本
cd /var/www
sudo cp -r asset-manager asset-manager-backup-$(date +%Y%m%d)

# 2. 更新代码（如果使用 Git）
cd asset-manager
git pull origin main

# 3. 更新后端依赖（如果需要）
cd server
npm install --production

# 4. 重启后端服务
pm2 restart asset-manager-api

# 5. 更新前端
cd ..
npm install
npm run build

# 6. 重载 Nginx（通常不需要重启）
sudo systemctl reload nginx
```

---

## 12. 安全建议

1. **修改默认密码**：首次登录后立即修改所有用户的默认密码
2. **使用强 JWT_SECRET**：生成随机字符串作为 JWT 密钥
3. **限制数据库访问**：只允许必要的 IP 访问数据库
4. **定期更新**：保持系统和依赖包的最新版本
5. **备份数据**：定期备份数据库
6. **监控日志**：定期检查应用和系统日志
7. **使用 HTTPS**：生产环境必须使用 HTTPS
8. **防火墙配置**：只开放必要的端口

---

## 13. 数据库备份和恢复

### 备份

```bash
# 备份数据库
sudo -u postgres pg_dump asset_manager > /backup/asset_manager_$(date +%Y%m%d).sql

# 压缩备份
gzip /backup/asset_manager_$(date +%Y%m%d).sql
```

### 恢复

```bash
# 解压备份文件
gunzip /backup/asset_manager_20240101.sql.gz

# 恢复数据库
sudo -u postgres psql asset_manager < /backup/asset_manager_20240101.sql
```

---

## 14. 性能优化建议

1. **启用 Nginx 缓存**：对静态资源启用缓存
2. **使用 CDN**：将静态资源托管到 CDN
3. **数据库优化**：添加适当的索引
4. **启用 Gzip**：已在 Nginx 配置中启用
5. **PM2 集群模式**：如果服务器性能足够，可以使用 PM2 集群模式

---

## 15. 联系支持

如果遇到问题，请检查：
1. 服务器日志：`pm2 logs`
2. Nginx 日志：`/var/log/nginx/error.log`
3. PostgreSQL 日志：`/var/log/postgresql/`
4. 浏览器控制台错误信息

---

**部署完成后，访问您的域名或 IP 地址即可使用系统！**

默认账号：
- 超级管理员：`superadmin` / `password123`
- 其他角色账号请查看数据库或初始化脚本

**重要：首次登录后请立即修改密码！**

