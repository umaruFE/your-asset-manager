# 统计报表使用指南

## 需求：查看附表8所有鱼类品种的结余重量和期末盘点重量

### 需求分析
- **表单**：附表8：生物资产管理台账
- **需要显示的字段**：
  - 鱼类品种（用于分组）
  - 结余重量 = 转入重量 - 转出重量（计算字段）
  - 期末盘点重量（需要显示）
- **聚合方式**：按鱼类品种分组，对转入重量和转出重量求和

### 操作步骤

#### 1. 进入统计报表页面
- 登录系统后，进入"统计报表"页面
- 点击"创建报表"按钮

#### 2. 填写基本信息
- **报表名称**：例如"鱼类品种结余重量统计"
- **报表描述**：例如"按鱼类品种统计结余重量和期末盘点重量"

#### 3. 选择表单
- 在"选择表单"区域，勾选 **"附表8：生物资产管理台账"**

#### 4. 选择字段（用于显示和分组）
在"选择字段"区域，勾选以下字段：
- ✅ **鱼类品种**（用于分组显示）
- ✅ **转入重量 (kg)**（用于计算）
- ✅ **转出重量 (kg)**（用于计算）
- ✅ **期末盘点重量 (kg)**（需要显示）

#### 5. 设置聚合函数
在"聚合函数"区域，点击"添加聚合函数"，设置：

**聚合函数 1：**
- 字段：**转入重量 (kg)**
- 函数：**SUM**（求和）

**聚合函数 2：**
- 字段：**转出重量 (kg)**
- 函数：**SUM**（求和）

**聚合函数 3：**
- 字段：**期末盘点重量 (kg)**
- 函数：**SUM**（求和）

> **注意**：聚合函数会将同一鱼类品种的所有记录进行汇总

#### 6. 创建计算字段（结余重量）
在"计算字段"区域，点击"添加计算字段"，然后：

1. 点击"选择字段"下拉框，选择 **"转入重量 (kg)"**
   - **重要**：由于"转入重量 (kg)"已经设置了SUM聚合函数，计算字段会自动使用聚合后的值（即所有记录的转入重量总和）
2. 点击"选择运算符"下拉框，选择 **"-"**（减号）
3. 点击"选择字段"下拉框，选择 **"转出重量 (kg)"**
   - **重要**：同样，"转出重量 (kg)"也会使用聚合后的值（即所有记录的转出重量总和）

表达式会自动构建为：`转入重量 (kg) - 转出重量 (kg)`

**字段名称**：可以修改为"结余重量 (kg)"

> **提示**：计算字段会自动识别哪些字段使用了聚合函数，并自动使用聚合后的值进行计算。例如，如果"转入重量 (kg)"使用了SUM聚合，计算字段会自动使用"转入重量 (kg)_SUM"的值。

#### 7. 保存和执行报表
- 点击"保存"按钮保存报表配置
- 点击"执行"按钮查看报表结果

### 报表结果说明

执行后，报表会显示类似以下格式的数据：

| 鱼类品种 | 转入重量 (kg)_SUM | 转出重量 (kg)_SUM | 期末盘点重量 (kg)_SUM | 结余重量 (kg) |
|---------|-----------------|-----------------|-------------------|-------------|
| 草鱼苗   | 500             | 100             | 50                | 400         |
| 鲤鱼苗   | 300             | 50              | 30                | 250         |

**说明**：
- **转入重量 (kg)_SUM**：该鱼类品种所有记录的转入重量总和
- **转出重量 (kg)_SUM**：该鱼类品种所有记录的转出重量总和
- **期末盘点重量 (kg)_SUM**：该鱼类品种所有记录的期末盘点重量总和
- **结余重量 (kg)**：转入重量总和 - 转出重量总和

### 常见问题

**Q: 为什么需要选择"鱼类品种"字段？**
A: 因为需要按鱼类品种分组显示，所以必须选择这个字段作为分组依据。

**Q: 为什么需要设置聚合函数？**
A: 因为同一鱼类品种可能有多个记录，需要将这些记录的数值进行汇总（求和）。

**Q: 计算字段中的字段选择是聚合后的值吗？**
A: 是的！如果某个字段在"聚合函数"中设置了聚合（如SUM），那么在"计算字段"中选择该字段时，会自动使用聚合后的值进行计算。例如：
- 如果"转入重量 (kg)"设置了SUM聚合
- 在计算字段中选择"转入重量 (kg)"
- 实际计算时使用的是"转入重量 (kg)_SUM"的值（即所有记录的转入重量总和）

这样，结余重量 = 所有记录的转入重量总和 - 所有记录的转出重量总和，这正是我们想要的结果。

**Q: 如果只想看某个基地的数据怎么办？**
A: 目前报表功能暂不支持按基地筛选，如果需要，可以联系管理员添加筛选功能。

### 示例配置截图说明

1. **选择表单**：勾选"附表8：生物资产管理台账"
2. **选择字段**：勾选"鱼类品种"、"转入重量 (kg)"、"转出重量 (kg)"、"期末盘点重量 (kg)"
3. **聚合函数**：
   - 转入重量 (kg) → SUM
   - 转出重量 (kg) → SUM
   - 期末盘点重量 (kg) → SUM
4. **计算字段**：
   - 名称：结余重量 (kg)
   - 表达式：转入重量 (kg) - 转出重量 (kg)

---

## 跨表查询：多个附表之间的字段查询

### 应用场景

在实际业务中，经常需要将多个附表的数据进行关联分析，例如：
- 比较不同附表的资产总额
- 计算不同附表之间的比率或差值
- 汇总多个附表的同类数据

### 操作步骤

#### 1. 选择多个表单

在"选择表单"区域，可以**同时勾选多个表单**，例如：
- ✅ 附表7：固定资产管理台账
- ✅ 附表8：生物资产管理台账
- ✅ 附表9：存货管理台账

> **提示**：选择多个表单后，系统会自动收集所有表单中的字段供您选择。

#### 2. 区分不同表单的字段

选择多个表单后，在"选择字段"、"聚合函数"和"计算字段"中，字段名称会显示为 **"表名:字段名"** 或 **"表名.字段名"** 的格式，例如：
- `附表7:资产名称`
- `附表8:鱼类品种`
- `附表9:存货名称`

这样可以清楚地区分不同表单中的同名字段。

#### 3. 跨表字段选择示例

**场景：比较附表7和附表8的资产总额**

1. **选择表单**：
   - ✅ 附表7：固定资产管理台账
   - ✅ 附表8：生物资产管理台账

2. **选择字段**（用于分组）：
   - ✅ `附表7:资产类别`（用于分组显示）

3. **设置聚合函数**：
   - **聚合函数 1**：
     - 字段：`附表7.资产原值`
     - 函数：SUM（求和）
   - **聚合函数 2**：
     - 字段：`附表8.转入重量 (kg)`
     - 函数：SUM（求和）

4. **创建计算字段**（跨表计算）：
   - 点击"添加计算字段"
   - 在"选择字段"下拉框中，选择 `附表7.资产原值`
   - 选择运算符：`+`（加号）
   - 再选择字段：`附表8.转入重量 (kg)`
   - 字段名称：`总资产价值`
   - 表达式：`附表7.资产原值 + 附表8.转入重量 (kg)`

> **注意**：如果字段使用了聚合函数，计算字段会自动使用聚合后的值。例如，如果 `附表7.资产原值` 设置了 SUM 聚合，计算时会使用 `附表7.资产原值_SUM` 的值。

#### 4. 跨表字段分组

**场景：按资产类别汇总多个附表的资产**

1. **选择表单**：
   - ✅ 附表7：固定资产管理台账
   - ✅ 附表8：生物资产管理台账

2. **选择字段**（用于分组）：
   - ✅ `附表7:资产类别`（作为分组依据）

3. **设置聚合函数**：
   - **聚合函数 1**：
     - 字段：`附表7.资产原值`
     - 函数：SUM
   - **聚合函数 2**：
     - 字段：`附表8.转入重量 (kg)`
     - 函数：SUM

4. **结果说明**：
   - 报表会按 `附表7:资产类别` 分组
   - 显示每个类别下：
     - `附表7.资产原值_SUM`：该类别在附表7中的资产原值总和
     - `附表8.转入重量 (kg)_SUM`：该类别在附表8中的转入重量总和

> **重要提示**：
> - 跨表分组时，只能使用**一个表单的字段**作为分组依据
> - 如果多个表单都有同名字段（如"资产类别"），需要明确选择是哪个表单的字段
> - 跨表聚合时，系统会分别对每个表单的数据进行聚合，然后合并显示

#### 5. 跨表计算字段示例

**场景：计算附表7和附表8的资产总额比率**

1. **选择表单**：
   - ✅ 附表7：固定资产管理台账
   - ✅ 附表8：生物资产管理台账

2. **选择字段**（用于分组）：
   - ✅ `附表7:资产类别`

3. **设置聚合函数**：
   - **聚合函数 1**：`附表7.资产原值` → SUM
   - **聚合函数 2**：`附表8.转入重量 (kg)` → SUM

4. **创建计算字段**（比率计算）：
   - 字段名称：`资产比率`
   - 表达式：`附表7.资产原值 / 附表8.转入重量 (kg)`
   - 说明：计算固定资产原值与生物资产转入重量的比率

> **注意**：如果分母可能为0，建议在计算前先检查数据，或使用条件判断。

### 跨表查询的注意事项

1. **字段名称格式**：
   - 在字段选择列表中，字段会显示为 `表名:字段名` 格式
   - 在聚合函数和计算字段中，字段会显示为 `表名.字段名` 格式
   - 这是为了区分不同表单中的同名字段

2. **分组字段限制**：
   - 跨表查询时，只能使用**一个表单的字段**作为分组依据
   - 如果需要在多个维度分组，建议创建多个报表

3. **聚合函数**：
   - 每个表单的字段可以独立设置聚合函数
   - 聚合是在各自表单的数据范围内进行的
   - 不同表单的聚合结果会合并显示在同一行（如果分组字段相同）

4. **计算字段**：
   - 可以在计算字段中使用不同表单的字段
   - 如果字段使用了聚合函数，计算时会自动使用聚合后的值
   - 支持四则运算（+、-、*、/）

5. **数据关联**：
   - 目前跨表查询是基于**分组字段的值**进行关联的
   - 例如，如果按"资产类别"分组，系统会将所有表单中相同"资产类别"的数据汇总在一起
   - 如果需要更复杂的关联（如通过ID关联），需要确保分组字段的值能够匹配

### 常见问题

**Q: 如何区分不同表单中的同名字段？**
A: 在字段选择列表中，字段会显示为 `表名:字段名` 格式，例如 `附表7:资产名称` 和 `附表8:资产名称`。在聚合函数和计算字段中，会显示为 `表名.字段名` 格式。

**Q: 跨表查询时，可以按多个字段分组吗？**
A: 目前系统支持按一个字段分组。如果需要多维度分组，建议创建多个报表，或者选择一个最合适的分组字段。

**Q: 跨表计算时，如果某个表单没有数据会怎样？**
A: 如果某个表单在某个分组下没有数据，聚合结果可能为 NULL 或 0。在计算字段中，NULL 值可能导致计算结果为 NULL。建议在设置聚合函数时，确保数据完整性。

**Q: 可以跨表进行 JOIN 操作吗？**
A: 目前系统不支持传统的 SQL JOIN 操作。跨表查询是基于分组字段的值进行关联的。如果需要在不同表单之间建立更复杂的关联关系，建议在数据录入时使用统一的关联字段（如资产编号、基地编号等）。

**Q: 跨表查询的性能如何？**
A: 跨表查询会同时查询多个表单的数据，如果数据量很大，可能会影响查询性能。建议：
- 合理选择分组字段，减少分组数量
- 使用适当的聚合函数，避免选择过多不必要的字段
- 如果数据量特别大，可以考虑分时段查询或联系管理员优化查询

### 跨表查询示例配置

**示例1：比较固定资产和生物资产总额**

1. **选择表单**：附表7、附表8
2. **选择字段**：`附表7:资产类别`
3. **聚合函数**：
   - `附表7.资产原值` → SUM
   - `附表8.转入重量 (kg)` → SUM
4. **计算字段**：
   - 名称：`总资产价值`
   - 表达式：`附表7.资产原值 + 附表8.转入重量 (kg)`

**示例2：计算不同附表的资产占比**

1. **选择表单**：附表7、附表8、附表9
2. **选择字段**：`附表7:资产类别`
3. **聚合函数**：
   - `附表7.资产原值` → SUM
   - `附表8.转入重量 (kg)` → SUM
   - `附表9.存货金额` → SUM
4. **计算字段**：
   - 名称：`固定资产占比`
   - 表达式：`附表7.资产原值 / (附表7.资产原值 + 附表8.转入重量 (kg) + 附表9.存货金额) * 100`

